<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Siesta PHP - stored procedure based ORM</title>

    <!-- Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/freelancer.css" rel="stylesheet">

    <link href="css/codeformat.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#page-top">Siesta PHP</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="/index.html">Overview</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/entities.html">Entities</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/index.html">Relationships</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/storedprocedure.html">Stored Procedures</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/driver.html">Driver</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- TOC Section -->
    <section class="success">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <br/><br/><h2>Entities</h2>
                    <hr class="star-light">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 text-center">
                    <p>
                        <a class="toc" href="#defining">Defining an entity</a><br/>
                        <a class="toc" href="#using">Using the entity with php</a><br/>
                        <a class="toc" href="#attributes">Adding attributes</a><br/>
                        <a class="toc" href="#addingIndex">Adding indexes</a><br/>
                        <a class="toc" href="#delimiting">Delimiting an entity</a><br/>
                        <a class="toc" href="#inmemory">In Memory replication with MySQL</a><br/>
                    </p>
                </div>
            </div>
        </div>
    </section>


    <!-- Defining Entities Section -->
    <section id="defining">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Defining Entities</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                            An entity always represents on table in the database. This will result in a generated class that
                            provides functionality for loading and storing the entity in the database table defined
                            Sample of Entity:
                        </p>

                        <pre class="prettyprint lang-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;entityList&gt;
    &lt;entity name="Artist" namespace="siestaphp\tests\gen" targetPath="gen/"&gt;
        &lt;attribute name="id" type="int" dbType="INT" primaryKey="true" required="true" autoValue="autoincrement"/&gt;
        &lt;attribute name="bool" type="bool" dbType="SMALLINT"/&gt;
        &lt;attribute name="int" type="int" dbType="INT"/&gt;
        &lt;attribute name="float" type="float" dbType="FLOAT"/&gt;
        &lt;attribute name="string" type="string" dbType="VARCHAR(100)"/&gt;
    &lt;/entity&gt;
&lt;/entityList&gt;</pre>

                        <h3>Available attributes for table element</h3>
                        <p>
                            <table class="attributeTable">
                                <tr>
                                    <td><b>Name</b></td>
                                    <td><b>Required</b></td>
                                    <td><b>default</b></td>
                                    <td><b>allowed values</b></td>
                                    <td><b>description</b></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td>yes</td>
                                    <td></td>
                                    <td>valid php class names</td>
                                    <td>Name of the class that is generated</td>
                                </tr>
                                <tr>
                                    <td>namespace</td>
                                    <td>no</td>
                                    <td></td>
                                    <td>valid php namespace</td>
                                    <td>Namespace of the class to generate</td>
                                </tr>
                                <tr>
                                    <td>constructClass</td>
                                    <td>no</td>
                                    <td>name of the class</td>
                                    <td>valid php class names</td>
                                    <td>Name of the class to instantiate</td>
                                </tr>
                                <tr>
                                    <td>constructNamespace</td>
                                    <td>no</td>
                                    <td>namespace of the class to generate</td>
                                    <td>valid php namespace</td>
                                    <td>Namespace of the class to instantiate</td>
                                </tr>
                                <tr>
                                    <td>table</td>
                                    <td>no</td>
                                    <td>name of the class</td>
                                    <td>valid database table names</td>
                                    <td>Name of the database table</td>
                                </tr>
                                <tr>
                                    <td>delimit</td>
                                    <td>no</td>
                                    <td><code>false</code></td>
                                    <td><code>true|false</code></td>
                                    <td>Allows to track history of the table</td>
                                </tr>
                                <tr>
                                    <td>targetPath</td>
                                    <td>no</td>
                                    <td>.</td>
                                    <td>valid path (does not need to exist)</td>
                                    <td>target path where to put generated classes</td>
                                </tr>
                            </table>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Using Entity Section -->
    <section id="using">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Using the entity with php</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                            An object can be instantiated with the classname respectively the construct classname.
                            Static methods allow to find or delete entities by primary key.
                        </p>

                        <pre class="prettyprint">
    // create new instance, set value and save
    $artist = new Artist();
    $artist->setName("Kruder &amp; Dorfmeister");
    $artist->save();
    <br/>
    // you can also initialize the Artist from an HttpRequest
    $artist->initializeFromHttpRequest($request);

    // you can initialize the object from a json object
    $artist->fromJSON($jsonString);

    // you can also transform the object to json
    $jsonString = $artist->toJSON();


    // you can also initialize an object from an array or transfer it to an array
    $artist->fromArray($arrayData);
    $arrayData = $artist->toArray();

    // finding an entity by primary key
    $artist2 = Artist::getEntityByPrimaryKey(4);

    // deleting an entity by primary key
    Artist::deleteEntityByPrimaryKey(4);</pre>

                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Adding attributes Section -->
    <section id="attributes">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Adding attributes</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                        <h3>Available attributes for the attribute element</h3>
                        <table class="attributeTable">
                            <tr>
                                <td>Name</td>
                                <td>Required</td>
                                <td>default</td>
                                <td>allowed values</td>
                                <td>description</td>
                            </tr>
                            <tr>
                                <td>name</td>
                                <td>yes</td>
                                <td></td>
                                <td>allowed php variable names</td>
                                <td>Name of the attribute that is generated</td>
                            </tr>
                            <tr>
                                <td>type</td>
                                <td>yes</td>
                                <td></td>
                                <td><code>bool|int|float|string|DateTime</code></td>
                                <td>defines the php type to use for the attribute</td>
                            </tr>
                            <tr>
                                <td>dbName</td>
                                <td>no</td>
                                <td>name of the attribute</td>
                                <td>allowed database column names</td>
                                <td>name of the column in the database</td>
                            </tr>
                            <tr>
                                <td>dbType</td>
                                <td>yes</td>
                                <td></td>
                                <td><code>INT, VARCHAR, BLOB</code> etc.</td>
                                <td>database type for the column to use</td>
                            </tr>
                            <tr>
                                <td>transient</td>
                                <td>no</td>
                                <td>false</td>
                                <td><code>true|false</code></td>
                                <td>allows to define attributes that are not stored in the database</td>
                            </tr>
                            <tr>
                                <td>primaryKey</td>
                                <td>no</td>
                                <td>false</td>
                                <td><code>true|false</code></td>
                                <td>allows to define a primarykey</td>
                            </tr>
                            <tr>
                                <td>defaultValue</td>
                                <td>no</td>
                                <td>null</td>
                                <td>valid php code : 'abc', 123 or <code>Factory::newDateTime()</code> </td>
                                <td>the default value to use for the attribute</td>
                            </tr>
                            <tr>
                                <td>required</td>
                                <td>no</td>
                                <td>false</td>
                                <td><code>true|false</code></td>
                                <td>creates a not null constraint for the table</td>
                            </tr>
                            <tr>
                                <td>autoValue</td>
                                <td>required for primary key columns</td>
                                <td></td>
                                <td>uuid|autoincrement</td>
                                <td>defines how the primary key column is set</td>
                            </tr>
                        </table>

                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Adding index Section -->
    <section id="addingIndex">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Adding indexes</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                            You can configure indexes within the entity.xml file. Every index needs a name. The unique flag
                            can be <code>true|false</code> and decides if the index is supposed to be unique.
                        </p>

                        <pre class="prettyprint">
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;entityList&gt;
        &lt;entity name="ArtistEntity" namespace="siestaphp\tests\functional\index\gen" targetPath="gen/"&gt;

            &lt;attribute name="string" type="string" dbName="DB_String" dbType="VARCHAR(100)"/&gt;
            &lt;attribute name="string2" type="string" dbType="VARCHAR(100)"/&gt;

            &lt;index name="uniqueIndex" unique="true" type="btree"&gt;
                &lt;indexPart columnName="DB_String" sortOrder="ASC" length="10"/&gt;
                &lt;indexPart columnName="string2" sortOrder="ASC" length=""/&gt;
            &lt;/index&gt;

            &lt;index name="nonUniqueIndex" unique="false" type="hash"&gt;
                &lt;indexPart columnName="string2" sortOrder="ASC" length="20"/&gt;
            &lt;/index&gt;
        &lt;/entity&gt;
    &lt;/entityList&gt;</pre>

                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Delimiting Section -->
    <section id="delimiting">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>Delimiting an entity</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                            Sometimes it is useful to archive changes that have been made to an entity. Siesta allows
                            to automatically generate an archive table which will store changes over time.
                            Use the <code>attribute delimit="true"</code> to enable the feature
                            for a specific table.
                        </p>

                        <pre class="prettyprint">
    mysql> show columns from Artist;
    +-------+--------------+------+-----+---------+-------+
    | Field | Type         | Null | Key | Default | Extra |
    +-------+--------------+------+-----+---------+-------+
    | id    | int(11)      | NO   | PRI | NULL    |       |
    | name  | varchar(100) | YES  |     | NULL    |       |
    | city  | varchar(100) | YES  |     | NULL    |       |
    +-------+--------------+------+-----+---------+-------+</pre>

                        <p>
                            With the delimit flag set to true, Siesta will generate a second table:
                        </p>

                        <pre class="prettyprint">
    mysql> show columns from Artist_delimit;
    +-------------+--------------+------+-----+---------+-------+
    | Field       | Type         | Null | Key | Default | Extra |
    +-------------+--------------+------+-----+---------+-------+
    | _delimit_id | varchar(36)  | NO   | PRI |         |       |
    | _validFrom  | datetime     | YES  |     | NULL    |       |
    | _validUntil | datetime     | YES  |     | NULL    |       |
    | _changedBy  | varchar(36)  | YES  |     | NULL    |       |
    | id          | int(11)      | NO   |     | NULL    |       |
    | name        | varchar(100) | YES  |     | NULL    |       |
    | city        | varchar(100) | YES  |     | NULL    |       |
    +-------------+--------------+------+-----+---------+-------+</pre>

                        <p>
                            The delimiter table contains the same columns like the original table (id, name, city).

                            Furthermore it comes with a a _delimit_id, _validFrom, _validUntil and _changedBy column.<br><br>
                            The following example shows how they are used
                        </p>

                        <pre class="prettyprint">
    mysql> select * from artist;
    +----+-----------+--------+
    | id | name      | city   |
    +----+-----------+--------+
    |  1 | MC Hammer | London |
    +----+-----------+--------+

    mysql> select * from artist_delimit;
    +-------------+---------------------+---------------------+------------+----+-----------+--------+
    | _delimit_id | _validFrom          | _validUntil         | _changedBy | id | name      | city   |
    +-------------+---------------------+---------------------+------------+----+-----------+--------+
    | 68f04490    | 1988-10-24 18:58:12 | NULL                | NULL       |  1 | MC Hammer | London |
    +-------------+---------------------+---------------------+------------+----+-----------+--------+</pre>

                        <p>
                            When the artist is initially created the delimiting table contains the entire record with a _validFrom data
                            and null for the _validUntil field, which indicates that this is the currently valid record. Let's rename
                            the artist to 'Hammer' and see what is happening.
                        </p>

                        <pre class="prettyprint">
    // finding an entity by primary key
    $hammer = Artist::getEntityByPrimaryKey(1);

    // rename
    $hammer->setName("Hammer");

    // save again
    $hammer->save();</pre>

                        <p>
                            This will result in the following table contents.
                        </p>

                        <pre class="prettyprint">
    mysql> select * from artist;
    +----+-----------+--------+
    | id | name      | city   |
    +----+-----------+--------+
    |  1 | MC Hammer | London |
    +----+-----------+--------+

    mysql> select * from artist_delimit;
    +-------------+---------------------+---------------------+------------+----+-----------+--------+
    | _delimit_id | _validFrom          | _validUntil         | _changedBy | id | name      | city   |
    +-------------+---------------------+---------------------+------------+----+-----------+--------+
    | 68f04490    | 1988-10-24 18:58:12 | 1992-10-24 18:58:12 | NULL       |  1 | MC Hammer | London |
    | 68f09bd4    | 1992-10-24 18:58:12 | NULL                | NULL       |  1 | Hammer    | NY     |
    +-------------+---------------------+---------------------+------------+----+-----------+--------+</pre>
                        <p>
                            The delimiting table contains 2 rows. The first one still shows the name 'MC Hammer' but with a VALID_UNTIL date
                            set. The second entry shows the new name 'Hammer' with a VALID_FROM date and NULL for the VALID_UNTIL (which
                            indicates this is the currently active record). Both entries refer to the same id 1 refering to the
                            id from the artist table.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- In memory replication -->
    <section id="inmemory">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1>In Memory replication with MySQL</h1>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="chapter">
                        <p>
                            MySQL allows to create tables with the <a href="https://dev.mysql.com/doc/refman/5.5/en/memory-storage-engine.html">Memory engine.</a>
                            The Memory engine is stored in the memory rather than on hard disk. Siesta allows to replicate a table with the memory engine. The same
                            table will be present with configured engine and with the memory engine.
                        </p>

                        <pre class="prettyprint">
    mysql> show tables from SIESTA_TEST;
    +-----------------------+
    | Tables_in_siesta_test |
    +-----------------------+
    | Book                  |
    | Book_MEMORY           |
    +-----------------------+</pre>

                        <p>
                            Every save operation will result in INSERT/UPDATE statement for both tables. However SELECT statement are working on the memory
                            table only. The following shows the insert procedure which is invoked on <code>$book->save();</code> It updates both the memory
                            table as well as the persistence table.
                        </p>
                        <pre class="prettyprint">
    # stored procedure to Insert a book
    CREATE PROCEDURE `Book_I` (IN P_id VARCHAR(36),IN P_title VARCHAR(100),IN P_price FLOAT)
    MODIFIES SQL DATA SQL SECURITY INVOKER
    BEGIN
        INSERT INTO `Book` ( `id`,`title`,`price` ) VALUES ( P_id,P_title,P_price );
        INSERT INTO `Book_MEMORY` ( `id`,`title`,`price` ) VALUES ( P_id,P_title,P_price );
    END

    #stored procedure to find by primary key
    CREATE PROCEDURE `Book_FBPK`(IN P_id VARCHAR(36))
    READS SQL DATA SQL SECURITY INVOKER
    BEGIN
        SELECT * FROM `Book_MEMORY` WHERE `id` = P_id;
    END</pre>

                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4">
                        <h3>Location</h3>
                        <p>Berlin</p>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Around the Web</h3>
                        <ul class="list-inline">
                            <li>
                                <a href="https://github.com/gperler/siesta" class="btn-social btn-outline"><i class="fa fa-fw fa-dribbble"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>About Siesta PHP</h3>
                        <p>Freelance is a free to use, open source PHP ORM.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; Siesta PHP
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-top page-scroll visible-xs visible-sm">
        <a class="btn btn-primary" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/freelancer.js"></script>

</body>

</html>
